<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"/><link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png"/><link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"/><link rel="manifest" href="/site.webmanifest"/><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#1c64f2"/><meta name="apple-mobile-web-app-title" content="Mohit Singh"/><meta name="application-name" content="Mohit Singh"/><meta name="msapplication-TileColor" content="#2d89ef"/><meta name="theme-color" content="#ffffff"/><meta charSet="utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Building a link shortener | Blog of Mohit Singh</title><meta name="description" content="A while back, I was asked to write a link shortener for a startup. It took me a day to come up with a production ready version but I warned them about collisions and other possible limitations."/><link href="https://mohitsingh.in/sitemap.xml" rel="sitemap" type="application/xml" title="Sitemap"/><meta content="wmG9n4x_BUWryqpD2K4wEF9Edfh_LNapQe-qfbv4D3o" name="google-site-verification"/><link rel="canonical" href="https://mohitsingh.in/code/building-a-link-shortner"/><meta name="next-head-count" content="7"/><link rel="preload" href="/_next/static/css/17108455eac6aad5c488.css" as="style"/><link rel="stylesheet" href="/_next/static/css/17108455eac6aad5c488.css" data-n-g=""/><link rel="preload" href="/_next/static/css/e1fe27d84a18852b7129.css" as="style"/><link rel="stylesheet" href="/_next/static/css/e1fe27d84a18852b7129.css" data-n-p=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-a54b4f32bdc1ef890ddd.js"></script><script src="/_next/static/chunks/webpack-715feba1dbc96f0c4f3f.js" defer=""></script><script src="/_next/static/chunks/framework-2191d16384373197bc0a.js" defer=""></script><script src="/_next/static/chunks/main-b9780dc6f4fa7abb3771.js" defer=""></script><script src="/_next/static/chunks/pages/_app-d164e74ceea89891f9ba.js" defer=""></script><script src="/_next/static/chunks/pages/%5B...posts%5D-68cf0e6a6b64b0c1d37b.js" defer=""></script><script src="/_next/static/vLj-h1l1iYxo80BnxHitK/_buildManifest.js" defer=""></script><script src="/_next/static/vLj-h1l1iYxo80BnxHitK/_ssgManifest.js" defer=""></script></head><body><div id="__next"><main class="flex flex-col flex-grow flex-shrink-0"><article class="w-full px-4 py-24" itemID="#" itemscope="" itemType="http://schema.org/BlogPosting"><header class="w-full mx-auto mb-12 text-center md:w-2/3"><h1 class="mb-3 text-4xl font-bold text-gray-700 md:leading-tight md:text-5xl" itemProp="headline" title="Building a link shortener">Building a link shortener</h1><p class="text-xs text-gray-600 md:text-sm">Written by<span class="font-medium text-gray-700" itemProp="author" itemscope="" itemType="http://schema.org/Person"><span itemProp="name"> <!-- -->Mohit Singh<!-- --> </span></span>on <time itemProp="datePublished dateModified" dateTime="Mon Jul 26 2021" pubdate="true">Mon Jul 26 2021</time></p></header><section class="mx-auto prose"><p>A while back, I was asked to write a link shortener for a startup. It took me a day to come up with a production ready version, but I warned them about collisions and other possible limitations. I used <a href="https://github.com/ai/nanoid" rel="nofollow noopener noreferrer">nanoid</a> to generate IDs. They asked me to use Mongo along with Express, and I did so. Not the best choice due to limited opportunity of optimizations.</p>
<p>Fast-forward a few months, that link shortener was performing well on a two core ec2 instance. I left that startup later, but one problem that stuck with me was collisions. They used to face errors due to collisions. Collisions increased with time, having some business impact.</p>
<h2>Rebuilding</h2>
<p>Later, I decided to write an open source link shortener. I picked <a href="https://github.com/gofiber/fiber" rel="nofollow noopener noreferrer">Fiber</a> (Go) and PostgreSQL instead of Express and Mongo <a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a>. After some hours, I had a working link shortener, which was already faster and reliable than what I created previously. I still had to fix a few things —</p>
<ul>
<li>Reducing lookup time</li>
<li>Minimizing failures</li>
<li>Increasing creation speed</li>
<li>Increasing retrieval speed</li>
<li>Adding analytics</li>
</ul>
<h2>Reducing lookup time</h2>
<p>Database lookup before creating every link was problematic. I decided to fix it first. After some digging, I came across <a href="https://en.wikipedia.org/wiki/Category:Probabilistic_data_structures" rel="nofollow noopener noreferrer">Probabilistic Data Structures</a>. The possible candidates were <a href="https://en.wikipedia.org/wiki/Bloom_filter" rel="nofollow noopener noreferrer">Bloom Filters</a>, <a href="https://en.wikipedia.org/wiki/Cuckoo_filter" rel="nofollow noopener noreferrer">Cuckoo Filters</a> and <a href="https://en.wikipedia.org/wiki/Quotient_filter" rel="nofollow noopener noreferrer">Quotient Filters</a>. After some testing and thinking, I picked <a href="https://en.wikipedia.org/wiki/Bloom_filter" rel="nofollow noopener noreferrer">Bloom Filters</a>.</p>
<p>When I was looking for implementations, I found out that <strong>Bitly</strong> had <a href="https://github.com/bitly/dablooms" rel="nofollow noopener noreferrer">one old implementation</a> in their GitHub repo <a href="#fn2" class="footnote-ref" id="fnref2" role="doc-noteref"><sup>2</sup></a>. I used <a href="https://github.com/bits-and-blooms/bloom" rel="nofollow noopener noreferrer">bloom</a> after writing a thread-safe wrapper around it. By using that to lookup before generating IDs, the lookup time reduced significantly.</p>
<h2>Minimizing failures</h2>
<p>When <a href="https://en.wikipedia.org/wiki/Bloom_filter" rel="nofollow noopener noreferrer">Bloom Filters</a> helped reduce lookup time, I figured out that I can utilize this reduced lookup time to minimize failures due to collisions. I implemented a recursive fallback ID generator with limit. Now, failures due to collisions were reduced, and this link shortener was almost fail-safe, yet much faster than previous one.</p>
<p>By now, I implemented a way to back up and restore these bloom filters. In case of missing backup, I generated bloom-filters from database.</p>
<h2>Increasing creation speed</h2>
<p>Since I was no longer using the database for checking the existence of an ID, the only db query left was <code class="language-text">create</code> query for link. Upon thinking about ways to speed this up, goroutines came in mind. I created a worker to queue and batch insert IDs. Now, for every link creation request, the link data was pushed in batch with the help of channels and since there was no collision of generated ID. This approach worked, and creation speed went up by a few times.</p>
<h2>Increasing retrieval speed</h2>
<p>Now that my link creation speed was way higher than retrieval, I wanted to optimize retrieval too, but I was limited by db connections. I tuned my PostgreSQL instance to have around 3000 connections <a href="#fn3" class="footnote-ref" id="fnref3" role="doc-noteref"><sup>3</sup></a>. This worked, but retrieval wasn't that fast. It still isn't, but the possible solution is to put these ID link pairs in Redis and use that. The insertion can be done on startup <a href="#fn4" class="footnote-ref" id="fnref4" role="doc-noteref"><sup>4</sup></a>.</p>
<h2>Adding analytics</h2>
<p>Since the real benefit of link shortener for businesses was to extract data and analyze traffic from these links. I decided to implement that too. I was already getting IP and User-Agent. All I needed was a user-agent parser and an IP info parser. I found <a href="https://github.com/mssola/user_agent" rel="nofollow noopener noreferrer">a good parser</a> for user agents and used <a href="https://dev.maxmind.com/geoip/geoip2/geolite2/" rel="nofollow noopener noreferrer">GeoLite2</a> from MaxMind to parse IP info. Since every click had info, I decided to implement a worker pool and sent data there for paring and batch ingestion to avoid request slowdowns.</p>
<p>As I've interacted with almost every popular TimeSeries Database, I picked <a href="https://github.com/timescale/timescaledb" rel="nofollow noopener noreferrer">Timescale</a> since it was already PostgreSQL based and was fast enough. <a href="#fn5" class="footnote-ref" id="fnref5" role="doc-noteref"><sup>5</sup></a>. The workers ingested events fine, and I had a good amount of data-points for every single click.</p>
<h2>Going crazy</h2>
<p>At some point, I thought about generating all IDs beforehand, randomizing them and using that to create links. No collisions at all. That could be stored in a few GB. I had some other crazy ideas, but I avoided them for now.</p>
<h2>Conclusion</h2>
<p>I named this after <strong>Wormholes</strong>, the imaginary links between two distant points in space. This system is still not finished. More databases can be supported, and analytics data can be rendered beautifully to make this a production ready and reliable system, but I'm already building something else and will come back to this later.</p>
<section class="footnotes" role="doc-endnotes">
<hr>
<ol>
<li id="fn1" role="doc-endnote">A database that I try to avoid<a href="#fnref1" class="footnote-back" role="doc-backlink">↩</a></li>
<li id="fn2" role="doc-endnote">Which I guess how they solved it too. Not sure if they still do the same<a href="#fnref2" class="footnote-back" role="doc-backlink">↩</a></li>
<li id="fn3" role="doc-endnote">Since, just bumping <code class="language-text">max_connections</code> doesn't work. I used <a href="https://pgtune.leopard.in.ua/" rel="nofollow noopener noreferrer">PGTune</a> to generate config for 3000 connections.<a href="#fnref3" class="footnote-back" role="doc-backlink">↩</a></li>
<li id="fn4" role="doc-endnote">Any better ideas ?<a href="#fnref4" class="footnote-back" role="doc-backlink">↩</a></li>
<li id="fn5" role="doc-endnote">I admit there were better choices and <a href="https://github.com/apache/druid" rel="nofollow noopener noreferrer">Druid</a> is my favorite, but this was a self-contained system and not a cluster-mess <a href="https://github.com/apache/druid" rel="nofollow noopener noreferrer">Druid</a> is and because I wanted to use <a href="https://github.com/timescale/timescaledb" rel="nofollow noopener noreferrer">Timescale</a><a href="#fnref5" class="footnote-back" role="doc-backlink">↩</a></li>
</ol>
</section>
</section></article></main><footer class="w-full py-4 text-center"><p class="text-xs text-gray-700">Copyright © 2021 Mohit Singh</p></footer></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"title":"Code","posts":[{"title":"A distributed link shortener","author":"Mohit Singh","date":"2021-09-04","excerpt":"In my post about building building link-shortener, I discussed about how I attempted to build a fully functional link shortener. That worked well but I was left with several questions during my previous attempt.","slug":"a-distributed-link-shortner","link":"code/a-distributed-link-shortner"},{"title":"On frontend tooling","author":"Mohit Singh","date":"2021-08-21","excerpt":"One thing I keep saying to people, Love it or hate it but it's still in your mind.. Same happens with me and frontend tooling. When I started creating websites and was recovering from my android madness, the state of frontend tooling was way more complex than today.","slug":"on-frontend-tooling","link":"code/on-frontend-tooling"},{"title":"Laws for Software Engineers","author":"Mohit Singh","date":"2021-08-12","excerpt":"Software Engineering is not always fun and sometimes we face results we never except. And then, there exits a whole set of principles and laws people came up with over time to answer these failures and patterns.","slug":"laws-for-software-engineers","link":"code/laws-for-software-engineers"},{"title":"Story of njk, a tool mistreated","author":"Mohit Singh","date":"2021-08-07","excerpt":"In 2014, I decide to build static websites for others in need, voluntarily. I didn't know much about web technologies but after a little research, I found that static-site-generators were a thing.","slug":"njk","link":"code/njk"},{"title":"Building a link shortener","author":"Mohit Singh","date":"2021-07-26","excerpt":"A while back, I was asked to write a link shortener for a startup. It took me a day to come up with a production ready version but I warned them about collisions and other possible limitations.","slug":"building-a-link-shortner","link":"code/building-a-link-shortner"},{"title":"Not The Tailwind Way","author":"Mohit Singh","date":"2021-07-25","excerpt":"I love Tailwind and it solves a lot of pain points I had writing CSS. The problem is, it pollutes my HTML well beyond refactoring and I've to be lucky to get something broken fixed.","slug":"no-tailwind","link":"code/no-tailwind"},{"title":"Hello","author":"Mohit Singh","date":"2021-07-21","excerpt":"I tried blogging a few times during last 8 years, but ended up stopping, but now I finally feel like I have courage to write things in my mind.","slug":"hello","link":"code/hello"}],"post":{"title":"Building a link shortener","author":"Mohit Singh","date":"2021-07-26","excerpt":"A while back, I was asked to write a link shortener for a startup. It took me a day to come up with a production ready version but I warned them about collisions and other possible limitations.","slug":"building-a-link-shortner","link":"code/building-a-link-shortner","content":"\u003cp\u003eA while back, I was asked to write a link shortener for a startup. It took me a day to come up with a production ready version, but I warned them about collisions and other possible limitations. I used \u003ca href=\"https://github.com/ai/nanoid\" rel=\"nofollow noopener noreferrer\"\u003enanoid\u003c/a\u003e to generate IDs. They asked me to use Mongo along with Express, and I did so. Not the best choice due to limited opportunity of optimizations.\u003c/p\u003e\n\u003cp\u003eFast-forward a few months, that link shortener was performing well on a two core ec2 instance. I left that startup later, but one problem that stuck with me was collisions. They used to face errors due to collisions. Collisions increased with time, having some business impact.\u003c/p\u003e\n\u003ch2\u003eRebuilding\u003c/h2\u003e\n\u003cp\u003eLater, I decided to write an open source link shortener. I picked \u003ca href=\"https://github.com/gofiber/fiber\" rel=\"nofollow noopener noreferrer\"\u003eFiber\u003c/a\u003e (Go) and PostgreSQL instead of Express and Mongo \u003ca href=\"#fn1\" class=\"footnote-ref\" id=\"fnref1\" role=\"doc-noteref\"\u003e\u003csup\u003e1\u003c/sup\u003e\u003c/a\u003e. After some hours, I had a working link shortener, which was already faster and reliable than what I created previously. I still had to fix a few things —\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eReducing lookup time\u003c/li\u003e\n\u003cli\u003eMinimizing failures\u003c/li\u003e\n\u003cli\u003eIncreasing creation speed\u003c/li\u003e\n\u003cli\u003eIncreasing retrieval speed\u003c/li\u003e\n\u003cli\u003eAdding analytics\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch2\u003eReducing lookup time\u003c/h2\u003e\n\u003cp\u003eDatabase lookup before creating every link was problematic. I decided to fix it first. After some digging, I came across \u003ca href=\"https://en.wikipedia.org/wiki/Category:Probabilistic_data_structures\" rel=\"nofollow noopener noreferrer\"\u003eProbabilistic Data Structures\u003c/a\u003e. The possible candidates were \u003ca href=\"https://en.wikipedia.org/wiki/Bloom_filter\" rel=\"nofollow noopener noreferrer\"\u003eBloom Filters\u003c/a\u003e, \u003ca href=\"https://en.wikipedia.org/wiki/Cuckoo_filter\" rel=\"nofollow noopener noreferrer\"\u003eCuckoo Filters\u003c/a\u003e and \u003ca href=\"https://en.wikipedia.org/wiki/Quotient_filter\" rel=\"nofollow noopener noreferrer\"\u003eQuotient Filters\u003c/a\u003e. After some testing and thinking, I picked \u003ca href=\"https://en.wikipedia.org/wiki/Bloom_filter\" rel=\"nofollow noopener noreferrer\"\u003eBloom Filters\u003c/a\u003e.\u003c/p\u003e\n\u003cp\u003eWhen I was looking for implementations, I found out that \u003cstrong\u003eBitly\u003c/strong\u003e had \u003ca href=\"https://github.com/bitly/dablooms\" rel=\"nofollow noopener noreferrer\"\u003eone old implementation\u003c/a\u003e in their GitHub repo \u003ca href=\"#fn2\" class=\"footnote-ref\" id=\"fnref2\" role=\"doc-noteref\"\u003e\u003csup\u003e2\u003c/sup\u003e\u003c/a\u003e. I used \u003ca href=\"https://github.com/bits-and-blooms/bloom\" rel=\"nofollow noopener noreferrer\"\u003ebloom\u003c/a\u003e after writing a thread-safe wrapper around it. By using that to lookup before generating IDs, the lookup time reduced significantly.\u003c/p\u003e\n\u003ch2\u003eMinimizing failures\u003c/h2\u003e\n\u003cp\u003eWhen \u003ca href=\"https://en.wikipedia.org/wiki/Bloom_filter\" rel=\"nofollow noopener noreferrer\"\u003eBloom Filters\u003c/a\u003e helped reduce lookup time, I figured out that I can utilize this reduced lookup time to minimize failures due to collisions. I implemented a recursive fallback ID generator with limit. Now, failures due to collisions were reduced, and this link shortener was almost fail-safe, yet much faster than previous one.\u003c/p\u003e\n\u003cp\u003eBy now, I implemented a way to back up and restore these bloom filters. In case of missing backup, I generated bloom-filters from database.\u003c/p\u003e\n\u003ch2\u003eIncreasing creation speed\u003c/h2\u003e\n\u003cp\u003eSince I was no longer using the database for checking the existence of an ID, the only db query left was \u003ccode class=\"language-text\"\u003ecreate\u003c/code\u003e query for link. Upon thinking about ways to speed this up, goroutines came in mind. I created a worker to queue and batch insert IDs. Now, for every link creation request, the link data was pushed in batch with the help of channels and since there was no collision of generated ID. This approach worked, and creation speed went up by a few times.\u003c/p\u003e\n\u003ch2\u003eIncreasing retrieval speed\u003c/h2\u003e\n\u003cp\u003eNow that my link creation speed was way higher than retrieval, I wanted to optimize retrieval too, but I was limited by db connections. I tuned my PostgreSQL instance to have around 3000 connections \u003ca href=\"#fn3\" class=\"footnote-ref\" id=\"fnref3\" role=\"doc-noteref\"\u003e\u003csup\u003e3\u003c/sup\u003e\u003c/a\u003e. This worked, but retrieval wasn't that fast. It still isn't, but the possible solution is to put these ID link pairs in Redis and use that. The insertion can be done on startup \u003ca href=\"#fn4\" class=\"footnote-ref\" id=\"fnref4\" role=\"doc-noteref\"\u003e\u003csup\u003e4\u003c/sup\u003e\u003c/a\u003e.\u003c/p\u003e\n\u003ch2\u003eAdding analytics\u003c/h2\u003e\n\u003cp\u003eSince the real benefit of link shortener for businesses was to extract data and analyze traffic from these links. I decided to implement that too. I was already getting IP and User-Agent. All I needed was a user-agent parser and an IP info parser. I found \u003ca href=\"https://github.com/mssola/user_agent\" rel=\"nofollow noopener noreferrer\"\u003ea good parser\u003c/a\u003e for user agents and used \u003ca href=\"https://dev.maxmind.com/geoip/geoip2/geolite2/\" rel=\"nofollow noopener noreferrer\"\u003eGeoLite2\u003c/a\u003e from MaxMind to parse IP info. Since every click had info, I decided to implement a worker pool and sent data there for paring and batch ingestion to avoid request slowdowns.\u003c/p\u003e\n\u003cp\u003eAs I've interacted with almost every popular TimeSeries Database, I picked \u003ca href=\"https://github.com/timescale/timescaledb\" rel=\"nofollow noopener noreferrer\"\u003eTimescale\u003c/a\u003e since it was already PostgreSQL based and was fast enough. \u003ca href=\"#fn5\" class=\"footnote-ref\" id=\"fnref5\" role=\"doc-noteref\"\u003e\u003csup\u003e5\u003c/sup\u003e\u003c/a\u003e. The workers ingested events fine, and I had a good amount of data-points for every single click.\u003c/p\u003e\n\u003ch2\u003eGoing crazy\u003c/h2\u003e\n\u003cp\u003eAt some point, I thought about generating all IDs beforehand, randomizing them and using that to create links. No collisions at all. That could be stored in a few GB. I had some other crazy ideas, but I avoided them for now.\u003c/p\u003e\n\u003ch2\u003eConclusion\u003c/h2\u003e\n\u003cp\u003eI named this after \u003cstrong\u003eWormholes\u003c/strong\u003e, the imaginary links between two distant points in space. This system is still not finished. More databases can be supported, and analytics data can be rendered beautifully to make this a production ready and reliable system, but I'm already building something else and will come back to this later.\u003c/p\u003e\n\u003csection class=\"footnotes\" role=\"doc-endnotes\"\u003e\n\u003chr\u003e\n\u003col\u003e\n\u003cli id=\"fn1\" role=\"doc-endnote\"\u003eA database that I try to avoid\u003ca href=\"#fnref1\" class=\"footnote-back\" role=\"doc-backlink\"\u003e↩\u003c/a\u003e\u003c/li\u003e\n\u003cli id=\"fn2\" role=\"doc-endnote\"\u003eWhich I guess how they solved it too. Not sure if they still do the same\u003ca href=\"#fnref2\" class=\"footnote-back\" role=\"doc-backlink\"\u003e↩\u003c/a\u003e\u003c/li\u003e\n\u003cli id=\"fn3\" role=\"doc-endnote\"\u003eSince, just bumping \u003ccode class=\"language-text\"\u003emax_connections\u003c/code\u003e doesn't work. I used \u003ca href=\"https://pgtune.leopard.in.ua/\" rel=\"nofollow noopener noreferrer\"\u003ePGTune\u003c/a\u003e to generate config for 3000 connections.\u003ca href=\"#fnref3\" class=\"footnote-back\" role=\"doc-backlink\"\u003e↩\u003c/a\u003e\u003c/li\u003e\n\u003cli id=\"fn4\" role=\"doc-endnote\"\u003eAny better ideas ?\u003ca href=\"#fnref4\" class=\"footnote-back\" role=\"doc-backlink\"\u003e↩\u003c/a\u003e\u003c/li\u003e\n\u003cli id=\"fn5\" role=\"doc-endnote\"\u003eI admit there were better choices and \u003ca href=\"https://github.com/apache/druid\" rel=\"nofollow noopener noreferrer\"\u003eDruid\u003c/a\u003e is my favorite, but this was a self-contained system and not a cluster-mess \u003ca href=\"https://github.com/apache/druid\" rel=\"nofollow noopener noreferrer\"\u003eDruid\u003c/a\u003e is and because I wanted to use \u003ca href=\"https://github.com/timescale/timescaledb\" rel=\"nofollow noopener noreferrer\"\u003eTimescale\u003c/a\u003e\u003ca href=\"#fnref5\" class=\"footnote-back\" role=\"doc-backlink\"\u003e↩\u003c/a\u003e\u003c/li\u003e\n\u003c/ol\u003e\n\u003c/section\u003e\n"}},"__N_SSG":true},"page":"/[...posts]","query":{"posts":["code","building-a-link-shortner"]},"buildId":"vLj-h1l1iYxo80BnxHitK","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>